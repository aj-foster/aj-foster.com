
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      <title>Handling AWS SNS Messages in Elixir &bull; AJ Foster</title>
    
    <link rel="stylesheet" href="/assets/css/app.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oranienbaum&display=swap&text=0123456789" rel="stylesheet">
    <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Sitewide Atom feed" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="me" href="https://hachyderm.io/@ajf">
  </head>

  <body>

    <div class="cell well">
    
      <section>
        
<nav class="nav">
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/about/">About</a></li>
    <li><a href="https://github.com/aj-foster/">GitHub</a></li>
    <li><a href="https://hachyderm.io/@ajf">Social</a></li>
  </ul>
</nav>

        <h1 id="handling-aws-sns-messages-in-elixir">Handling AWS SNS Messages in Elixir</h1><p>Posted on May 26, 2025. <a href="https://github.com/aj-foster/aj-foster.com/discussions">Discuss on GitHub</a></p><div class="article"><p>
I recently wanted to accept messages from an Amazon Web Services <a href="https://docs.aws.amazon.com/sns/latest/dg/welcome.html">Simple Notification Service</a> topic in an Elixir / Phoenix application.
An <a href="https://docs.aws.amazon.com/sns/latest/dg/sns-http-https-endpoint-as-subscriber.html">HTTPS endpoint</a> is just one way to subscribe to messages on a topic, but it’s the most relevant if you already have a web service running.
It took a bit of work — and the documentation led me astray for a while — so here’s a summary of the process.</p><h2 id="-sns-setup">
SNS Setup</h2><p>
We aren’t going to focus on the full setup of the SNS topic, but there is one very important setting you’ll need to adjust.</p><p>
By default, SNS sends messages with <code class="inline">Content-Type: text/plain; charset=UTF-8</code>.
As a result, you must either:</p><ol><li>
Manually decode the request body as JSON, or  </li><li>
Tell the SNS topic to send messages with the correct content type.  </li></ol><p>
The following Delivery Policy sets the content type while leaving all other settings at their default values:</p><pre><code class="makeup json"><span class="p" data-group-id="9503744102-1">{</span><span class="w">
  </span><span class="nt">&quot;http&quot;</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9503744102-2">{</span><span class="w">
    </span><span class="nt">&quot;defaultHealthyRetryPolicy&quot;</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9503744102-3">{</span><span class="w">
      </span><span class="nt">&quot;numRetries&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
      </span><span class="nt">&quot;numNoDelayRetries&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nt">&quot;minDelayTarget&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w">
      </span><span class="nt">&quot;maxDelayTarget&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w">
      </span><span class="nt">&quot;numMinDelayRetries&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nt">&quot;numMaxDelayRetries&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
      </span><span class="nt">&quot;backoffFunction&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;linear&quot;</span><span class="w">
    </span><span class="p" data-group-id="9503744102-3">}</span><span class="p">,</span><span class="w">
    </span><span class="nt">&quot;disableSubscriptionOverrides&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nt">&quot;defaultRequestPolicy&quot;</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9503744102-4">{</span><span class="w">
      </span><span class="nt">&quot;headerContentType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span><span class="w">
    </span><span class="p" data-group-id="9503744102-4">}</span><span class="w">
  </span><span class="p" data-group-id="9503744102-2">}</span><span class="w">
</span><span class="p" data-group-id="9503744102-1">}</span></code></pre><p>
Without taking one of these steps, the incoming connection struct will have empty <code class="inline">body_params</code>.</p><h2 id="-routing">
Routing</h2><p>
First we need to create the route for accepting the messages.
They will be HTTP POST requests at a path of your choosing.
I prefer to group webhook-like requests in a <code class="inline">/hook</code> scope with routes describing their source:</p><pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyAppWeb.Router</span><span class="w"> </span><span class="k" data-group-id="5827681828-1">do</span><span class="w">
  </span><span class="c1"># ...</span><span class="w">

  </span><span class="n">pipeline</span><span class="w"> </span><span class="ss">:hook</span><span class="w"> </span><span class="k" data-group-id="5827681828-2">do</span><span class="w">
    </span><span class="n">plug</span><span class="w"> </span><span class="ss">:accepts</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5827681828-3">[</span><span class="s">&quot;json&quot;</span><span class="p" data-group-id="5827681828-3">]</span><span class="w">
  </span><span class="k" data-group-id="5827681828-2">end</span><span class="w">

  </span><span class="n">scope</span><span class="w"> </span><span class="s">&quot;/hook&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">MyAppWeb</span><span class="w"> </span><span class="k" data-group-id="5827681828-4">do</span><span class="w">
    </span><span class="n">pipe_through</span><span class="w"> </span><span class="ss">:hook</span><span class="w">

    </span><span class="n">post</span><span class="w"> </span><span class="s">&quot;/sns&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">SNSController</span><span class="p">,</span><span class="w"> </span><span class="ss">:notification</span><span class="w">
  </span><span class="k" data-group-id="5827681828-4">end</span><span class="w">
</span><span class="k" data-group-id="5827681828-1">end</span></code></pre><p>
We want to process the incoming requests as JSON, but we don’t want any of the other plugs that might be part of a typical <code class="inline">:api</code> pipeline.</p><p><strong>Note</strong>: If you have experience dealing with webhooks, you may be inclined to modify the “reader” plug and ensure the original request body is preserved for verification later.
This is not necessary for verifying SNS messages.
All of the data you need comes from individual keys of the JSON body (not the raw body itself).</p><h2 id="-controller-action">
Controller Action</h2><p>
Let’s lay out a basic controller action to handle incoming messages:</p><pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyAppWeb.SNSController</span><span class="w"> </span><span class="k" data-group-id="1484898650-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Phoenix.Controller</span><span class="p">,</span><span class="w"> </span><span class="ss">formats</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1484898650-2">[</span><span class="ss">:json</span><span class="p" data-group-id="1484898650-2">]</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Plug.Conn</span><span class="w">

  </span><span class="n">action_fallback</span><span class="w"> </span><span class="ss">:fallback</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">notification</span><span class="p" data-group-id="1484898650-3">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="1484898650-3">)</span><span class="w"> </span><span class="k" data-group-id="1484898650-4">do</span><span class="w">
    </span><span class="k">with</span><span class="w"> </span><span class="ss">:ok</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">verify_message</span><span class="p" data-group-id="1484898650-5">(</span><span class="n">params</span><span class="p" data-group-id="1484898650-5">)</span><span class="p">,</span><span class="w">
         </span><span class="ss">:ok</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">handle_management_messages</span><span class="p" data-group-id="1484898650-6">(</span><span class="n">params</span><span class="p" data-group-id="1484898650-6">)</span><span class="w"> </span><span class="k" data-group-id="1484898650-7">do</span><span class="w">
      </span><span class="c1"># Handle message here.</span><span class="w">
      </span><span class="n">send_resp</span><span class="p" data-group-id="1484898650-8">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p" data-group-id="1484898650-8">)</span><span class="w">
    </span><span class="k" data-group-id="1484898650-7">end</span><span class="w">
  </span><span class="k" data-group-id="1484898650-4">end</span><span class="w">

  </span><span class="c1">#</span><span class="w">
  </span><span class="c1"># Fallback</span><span class="w">
  </span><span class="c1">#</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="no">false</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">fallback</span><span class="p" data-group-id="1484898650-9">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1484898650-10">{</span><span class="ss">:ignore</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1484898650-10">}</span><span class="p" data-group-id="1484898650-9">)</span><span class="w">
      </span><span class="ow">when</span><span class="w"> </span><span class="n">is_binary</span><span class="p" data-group-id="1484898650-11">(</span><span class="n">reason</span><span class="p" data-group-id="1484898650-11">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">send_resp</span><span class="p" data-group-id="1484898650-12">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1484898650-12">)</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">fallback</span><span class="p" data-group-id="1484898650-13">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1484898650-14">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1484898650-14">}</span><span class="p" data-group-id="1484898650-13">)</span><span class="w">
      </span><span class="ow">when</span><span class="w"> </span><span class="n">is_atom</span><span class="p" data-group-id="1484898650-15">(</span><span class="n">code</span><span class="p" data-group-id="1484898650-15">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">is_binary</span><span class="p" data-group-id="1484898650-16">(</span><span class="n">reason</span><span class="p" data-group-id="1484898650-16">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">send_resp</span><span class="p" data-group-id="1484898650-17">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1484898650-17">)</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">fallback</span><span class="p" data-group-id="1484898650-18">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1484898650-19">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1484898650-19">}</span><span class="p" data-group-id="1484898650-18">)</span><span class="w">
      </span><span class="ow">when</span><span class="w"> </span><span class="n">is_binary</span><span class="p" data-group-id="1484898650-20">(</span><span class="n">reason</span><span class="p" data-group-id="1484898650-20">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">send_resp</span><span class="p" data-group-id="1484898650-21">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:internal_server_error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1484898650-21">)</span><span class="w">
</span><span class="k" data-group-id="1484898650-1">end</span></code></pre><p>
There’s a lot going on already, so let’s break it down:</p><ol><li>
While you can <code class="inline">use MyAppWeb, :controller</code> as is normal in a Phoenix controller, we’ve skipped that and directly called the <code class="inline">use</code> and <code class="inline">import</code>s we need.  </li><li>
If validating the authenticity of a message fails, we want to return an error and abort further processing.
An <code class="inline">action_fallback</code> using a local function makes this easy while maintaining readability.  </li><li>
SNS sends two types of “management” messages, <code class="inline">SubscriptionConfirmation</code> and <code class="inline">UnsubscribeConfirmation</code>.
Neither of these are messages that should be handled by our normal handler, so we will instead return <code class="inline">{:ignore, ...}</code> to abort processing.  </li><li>
If we successfully handle a message, an empty 200 response is perfect.  </li></ol><p>
Next we’ll fill in the details of <code class="inline">verify_message/1</code> and <code class="inline">handle_management_messages/1</code>.</p><h2 id="-verify-messages">
Verify Messages</h2><p>
Message verification ensures that messages come from Amazon, and not from some random person running a <code class="inline">curl</code> command in their terminal.
It <strong>does not</strong> tell us that the message came from the topic we expected — we still have to verify that ourselves — but it <strong>does</strong> tell us that the topic listed in the message is accurate.</p><p>
Amazon provides <a href="https://docs.aws.amazon.com/sns/latest/dg/sns-verify-signature-of-message.html">some documentation</a> about the process of verifying messages, and it’s a good idea to read through it.
However, there are a few details that may be misleading when implementing it in another language.
So, let’s talk through it.</p><pre><code class="makeup elixir"><span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">verify_message</span><span class="p" data-group-id="3308685554-1">(</span><span class="n">map</span><span class="p" data-group-id="3308685554-1">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="ss">:ok</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="3308685554-2">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="3308685554-3">(</span><span class="p" data-group-id="3308685554-3">)</span><span class="p" data-group-id="3308685554-2">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">verify_message</span><span class="p" data-group-id="3308685554-4">(</span><span class="n">message</span><span class="p" data-group-id="3308685554-4">)</span><span class="w"> </span><span class="k" data-group-id="3308685554-5">do</span><span class="w">
    </span><span class="n">string_to_sign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">construct_signed_string</span><span class="p" data-group-id="3308685554-6">(</span><span class="n">message</span><span class="p" data-group-id="3308685554-6">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w">

    </span><span class="k">with</span><span class="w"> </span><span class="p" data-group-id="3308685554-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="3308685554-7">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_public_key</span><span class="p" data-group-id="3308685554-8">(</span><span class="n">message</span><span class="p" data-group-id="3308685554-9">[</span><span class="s">&quot;SigningCertURL&quot;</span><span class="p" data-group-id="3308685554-9">]</span><span class="p" data-group-id="3308685554-8">)</span><span class="p">,</span><span class="w">
         </span><span class="p" data-group-id="3308685554-10">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">hash_algorithm</span><span class="p" data-group-id="3308685554-10">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_hash_algorithm</span><span class="p" data-group-id="3308685554-11">(</span><span class="n">message</span><span class="p" data-group-id="3308685554-12">[</span><span class="s">&quot;SignatureVersion&quot;</span><span class="p" data-group-id="3308685554-12">]</span><span class="p" data-group-id="3308685554-11">)</span><span class="p">,</span><span class="w">
         </span><span class="p" data-group-id="3308685554-13">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">decoded_signature</span><span class="p" data-group-id="3308685554-13">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">decode_signature</span><span class="p" data-group-id="3308685554-14">(</span><span class="n">message</span><span class="p" data-group-id="3308685554-15">[</span><span class="s">&quot;Signature&quot;</span><span class="p" data-group-id="3308685554-15">]</span><span class="p" data-group-id="3308685554-14">)</span><span class="w"> </span><span class="k" data-group-id="3308685554-16">do</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="nc">:public_key</span><span class="o">.</span><span class="n">verify</span><span class="p" data-group-id="3308685554-17">(</span><span class="n">string_to_sign</span><span class="p">,</span><span class="w"> </span><span class="n">hash_algorithm</span><span class="p">,</span><span class="w"> </span><span class="n">decoded_signature</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="3308685554-17">)</span><span class="w"> </span><span class="k" data-group-id="3308685554-18">do</span><span class="w">
        </span><span class="ss">:ok</span><span class="w">
      </span><span class="k" data-group-id="3308685554-18">else</span><span class="w">
        </span><span class="p" data-group-id="3308685554-19">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Signature verification failed&quot;</span><span class="p" data-group-id="3308685554-19">}</span><span class="w">
      </span><span class="k" data-group-id="3308685554-18">end</span><span class="w">
    </span><span class="k" data-group-id="3308685554-16">end</span><span class="w">
  </span><span class="k" data-group-id="3308685554-5">end</span></code></pre><p>
To complete message verification, we will (1) construct the signed string, (2) get the public key used to sign the message, (3) determine the hash algorithm to use, (4) decode the signature, and (5) verify the signature.</p><h3 id="-construct-signed-string">
Construct Signed String</h3><p>
Like many popular webhook providers, SNS provides a message <em>signature</em> to provide cryptographic proof that a message comes from Amazon and has not been tampered with.
Unlike many popular webhook providers, the signature is not based on the full raw message body, but rather a subset of message fields that are concatenated together in a particular way.
(This is because the signature itself is part of the message body, rather than a header.)</p><p>
As a result, we need to construct the signed string ourselves:</p><pre><code class="makeup elixir"><span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">construct_signed_string</span><span class="p" data-group-id="5819538738-1">(</span><span class="n">map</span><span class="p" data-group-id="5819538738-1">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="5819538738-2">(</span><span class="p" data-group-id="5819538738-2">)</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">construct_signed_string</span><span class="p" data-group-id="5819538738-3">(</span><span class="n">message</span><span class="p" data-group-id="5819538738-3">)</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">construct_signed_string</span><span class="p" data-group-id="5819538738-4">(</span><span class="p" data-group-id="5819538738-5">%{</span><span class="s">&quot;Type&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;Notification&quot;</span><span class="p" data-group-id="5819538738-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="5819538738-4">)</span><span class="w"> </span><span class="k" data-group-id="5819538738-6">do</span><span class="w">
    </span><span class="n">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="5819538738-7">[</span><span class="s">&quot;Subject&quot;</span><span class="p" data-group-id="5819538738-7">]</span><span class="w">

    </span><span class="p" data-group-id="5819538738-8">[</span><span class="w">
      </span><span class="s">&quot;Message&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="5819538738-9">[</span><span class="s">&quot;Message&quot;</span><span class="p" data-group-id="5819538738-9">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;MessageId&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="5819538738-10">[</span><span class="s">&quot;MessageId&quot;</span><span class="p" data-group-id="5819538738-10">]</span><span class="p">,</span><span class="w">
      </span><span class="k">if</span><span class="p" data-group-id="5819538738-11">(</span><span class="n">subject</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Subject&quot;</span><span class="p" data-group-id="5819538738-11">)</span><span class="p">,</span><span class="w">
      </span><span class="k">if</span><span class="p" data-group-id="5819538738-12">(</span><span class="n">subject</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">subject</span><span class="p" data-group-id="5819538738-12">)</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;Timestamp&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="5819538738-13">[</span><span class="s">&quot;Timestamp&quot;</span><span class="p" data-group-id="5819538738-13">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;TopicArn&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="5819538738-14">[</span><span class="s">&quot;TopicArn&quot;</span><span class="p" data-group-id="5819538738-14">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;Type&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="5819538738-15">[</span><span class="s">&quot;Type&quot;</span><span class="p" data-group-id="5819538738-15">]</span><span class="w">
    </span><span class="p" data-group-id="5819538738-8">]</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reject</span><span class="p" data-group-id="5819538738-16">(</span><span class="o">&amp;</span><span class="n">is_nil</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="5819538738-16">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="5819538738-17">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p" data-group-id="5819538738-17">)</span><span class="w">
  </span><span class="k" data-group-id="5819538738-6">end</span><span class="w">

  </span><span class="c1"># Catch-all: SubscriptionConfirmation and UnsubscribeConfirmation</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">construct_signed_string</span><span class="p" data-group-id="5819538738-18">(</span><span class="n">message</span><span class="p" data-group-id="5819538738-18">)</span><span class="w"> </span><span class="k" data-group-id="5819538738-19">do</span><span class="w">
    </span><span class="p" data-group-id="5819538738-20">[</span><span class="w">
      </span><span class="s">&quot;Message&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="5819538738-21">[</span><span class="s">&quot;Message&quot;</span><span class="p" data-group-id="5819538738-21">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;MessageId&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="5819538738-22">[</span><span class="s">&quot;MessageId&quot;</span><span class="p" data-group-id="5819538738-22">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;SubscribeURL&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="5819538738-23">[</span><span class="s">&quot;SubscribeURL&quot;</span><span class="p" data-group-id="5819538738-23">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;Timestamp&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="5819538738-24">[</span><span class="s">&quot;Timestamp&quot;</span><span class="p" data-group-id="5819538738-24">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;Token&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="5819538738-25">[</span><span class="s">&quot;Token&quot;</span><span class="p" data-group-id="5819538738-25">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;TopicArn&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="5819538738-26">[</span><span class="s">&quot;TopicArn&quot;</span><span class="p" data-group-id="5819538738-26">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;Type&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="5819538738-27">[</span><span class="s">&quot;Type&quot;</span><span class="p" data-group-id="5819538738-27">]</span><span class="w">
    </span><span class="p" data-group-id="5819538738-20">]</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="5819538738-28">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p" data-group-id="5819538738-28">)</span><span class="w">
  </span><span class="k" data-group-id="5819538738-19">end</span></code></pre><p>
As mentioned in <a href="https://docs.aws.amazon.com/sns/latest/dg/sns-verify-signature-of-message-verify-message-signature.html">the documentation</a>, we extract certain fields from the message depending on the message type.
If the subject field is empty, we omit it.</p><p><strong>Warning</strong>: At the time of writing, the instructions also say “Important: Do not add a newline character at the end of the string.”
This is misleading, as the binary passed to <code class="inline">:public_key.verify/4</code> must have a trailing newline in order to succeed.
However, this newline is implicitly added in their example <code class="inline">echo</code> command, so it’s important not to add <em>an additional newline</em> at the end.
I’ve sent in feedback on how this might be worded better.</p><p>
We add a final newline to the constructed string back in <code class="inline">verify_message/1</code>.</p><h3 id="-get-public-key">
Get Public Key</h3><p>
The message signature is created using a public key provided by Amazon.
In order to verify it, we have to download and decode the key.</p><pre><code class="makeup elixir"><span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">get_public_key</span><span class="p" data-group-id="0368044188-1">(</span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="0368044188-2">(</span><span class="p" data-group-id="0368044188-2">)</span><span class="p" data-group-id="0368044188-1">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="0368044188-3">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="nc">:public_key</span><span class="o">.</span><span class="n">public_key</span><span class="p" data-group-id="0368044188-4">(</span><span class="p" data-group-id="0368044188-4">)</span><span class="p" data-group-id="0368044188-3">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="0368044188-5">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="0368044188-6">(</span><span class="p" data-group-id="0368044188-6">)</span><span class="p" data-group-id="0368044188-5">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">get_public_key</span><span class="p" data-group-id="0368044188-7">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="0368044188-7">)</span><span class="w"> </span><span class="k" data-group-id="0368044188-8">do</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:persistent_term</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="0368044188-9">(</span><span class="p" data-group-id="0368044188-10">{</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">signing_cert_url</span><span class="p" data-group-id="0368044188-10">}</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="0368044188-9">)</span><span class="w"> </span><span class="k" data-group-id="0368044188-11">do</span><span class="w">
      </span><span class="p" data-group-id="0368044188-12">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="0368044188-12">}</span><span class="w">
    </span><span class="k" data-group-id="0368044188-11">else</span><span class="w">
      </span><span class="k">with</span><span class="w"> </span><span class="ss">:ok</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">validate_signing_cert_url</span><span class="p" data-group-id="0368044188-13">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="0368044188-13">)</span><span class="p">,</span><span class="w">
           </span><span class="p" data-group-id="0368044188-14">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">cert</span><span class="p" data-group-id="0368044188-14">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">download_signing_cert</span><span class="p" data-group-id="0368044188-15">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="0368044188-15">)</span><span class="p">,</span><span class="w">
           </span><span class="p" data-group-id="0368044188-16">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="0368044188-16">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">decode_signing_cert</span><span class="p" data-group-id="0368044188-17">(</span><span class="n">cert</span><span class="p" data-group-id="0368044188-17">)</span><span class="w"> </span><span class="k" data-group-id="0368044188-18">do</span><span class="w">
        </span><span class="nc">:persistent_term</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="0368044188-19">(</span><span class="p" data-group-id="0368044188-20">{</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">signing_cert_url</span><span class="p" data-group-id="0368044188-20">}</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="0368044188-19">)</span><span class="w">
        </span><span class="p" data-group-id="0368044188-21">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="0368044188-21">}</span><span class="w">
      </span><span class="k" data-group-id="0368044188-18">end</span><span class="w">
    </span><span class="k" data-group-id="0368044188-11">end</span><span class="w">
  </span><span class="k" data-group-id="0368044188-8">end</span></code></pre><p>
Because this step requires making an external network call, it isn’t something we want to repeat for every message that arrives.
We can store the results of the decoding in <code class="inline">persistent_term</code> storage (or something similar, like an ETS table) to improve performance.</p><p>
The process fo downloading and decoding the certificate requires:</p><ol><li>
Validating the certificate URL to ensure it comes from Amazon,  </li><li>
Downloading the certificate, and   </li><li>
Decoding the public key from the certificate file.  </li></ol><h4 id="-validate-certificate-url">
Validate Certificate URL</h4><p>
In order to avoid downloading and processing a potentially malicious file, we need to validate that the signing certificate URL provided in the message is trustworthy.
Valid signing certificates are hosted at <code class="inline">sns.[region].amazonaws.com</code>, so we can check the hostname against this pattern:</p><pre><code class="makeup elixir"><span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">validate_signing_cert_url</span><span class="p" data-group-id="2208337006-1">(</span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="2208337006-2">(</span><span class="p" data-group-id="2208337006-2">)</span><span class="p" data-group-id="2208337006-1">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="ss">:ok</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="2208337006-3">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="2208337006-4">(</span><span class="p" data-group-id="2208337006-4">)</span><span class="p" data-group-id="2208337006-3">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">validate_signing_cert_url</span><span class="p" data-group-id="2208337006-5">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="2208337006-5">)</span><span class="w"> </span><span class="k" data-group-id="2208337006-6">do</span><span class="w">
    </span><span class="n">valid_hostname?</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">URI</span><span class="o">.</span><span class="n">parse</span><span class="p" data-group-id="2208337006-7">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="2208337006-7">)</span><span class="o">.</span><span class="n">host</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">match?</span><span class="p" data-group-id="2208337006-8">(</span><span class="sr">~r/^sns</span><span class="se">\.</span><span class="sr">[a-zA-Z0-9</span><span class="se">\-</span><span class="sr">]+</span><span class="se">\.</span><span class="sr">amazonaws</span><span class="se">\.</span><span class="sr">com$/</span><span class="p" data-group-id="2208337006-8">)</span><span class="w">

    </span><span class="k">if</span><span class="w"> </span><span class="n">valid_hostname?</span><span class="w"> </span><span class="k" data-group-id="2208337006-9">do</span><span class="w">
      </span><span class="ss">:ok</span><span class="w">
    </span><span class="k" data-group-id="2208337006-9">else</span><span class="w">
      </span><span class="p" data-group-id="2208337006-10">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid signing certificate URL&quot;</span><span class="p" data-group-id="2208337006-10">}</span><span class="w">
    </span><span class="k" data-group-id="2208337006-9">end</span><span class="w">
  </span><span class="k" data-group-id="2208337006-6">end</span></code></pre><h4 id="-download-signing-certificate">
Download Signing Certificate</h4><p>
Downloading the certificate file is straightforward using your HTTP client of choice:</p><pre><code class="makeup elixir"><span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">download_signing_cert</span><span class="p" data-group-id="5160511550-1">(</span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="5160511550-2">(</span><span class="p" data-group-id="5160511550-2">)</span><span class="p" data-group-id="5160511550-1">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="5160511550-3">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">binary</span><span class="p" data-group-id="5160511550-3">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="5160511550-4">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="5160511550-5">(</span><span class="p" data-group-id="5160511550-5">)</span><span class="p" data-group-id="5160511550-4">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">download_signing_cert</span><span class="p" data-group-id="5160511550-6">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="5160511550-6">)</span><span class="w"> </span><span class="k" data-group-id="5160511550-7">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Req</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="5160511550-8">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="5160511550-8">)</span><span class="w"> </span><span class="k" data-group-id="5160511550-9">do</span><span class="w">
      </span><span class="p" data-group-id="5160511550-10">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5160511550-11">%</span><span class="nc" data-group-id="5160511550-11">Req.Response</span><span class="p" data-group-id="5160511550-11">{</span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="ss">body</span><span class="p">:</span><span class="w"> </span><span class="n">body</span><span class="p" data-group-id="5160511550-11">}</span><span class="p" data-group-id="5160511550-10">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="5160511550-12">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p" data-group-id="5160511550-12">}</span><span class="w">

      </span><span class="p" data-group-id="5160511550-13">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5160511550-14">%</span><span class="nc" data-group-id="5160511550-14">Req.Response</span><span class="p" data-group-id="5160511550-14">{</span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="n">status</span><span class="p" data-group-id="5160511550-14">}</span><span class="p" data-group-id="5160511550-13">}</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mi">400</span><span class="o">..</span><span class="mi">599</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="5160511550-15">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to fetch signing certificate: HTTP </span><span class="si" data-group-id="5160511550-16">#{</span><span class="n">status</span><span class="si" data-group-id="5160511550-16">}</span><span class="s">&quot;</span><span class="p" data-group-id="5160511550-15">}</span><span class="w">

      </span><span class="p" data-group-id="5160511550-17">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="5160511550-17">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="5160511550-18">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to fetch signing certificate: </span><span class="si" data-group-id="5160511550-19">#{</span><span class="n">inspect</span><span class="p" data-group-id="5160511550-20">(</span><span class="n">reason</span><span class="p" data-group-id="5160511550-20">)</span><span class="si" data-group-id="5160511550-19">}</span><span class="s">&quot;</span><span class="p" data-group-id="5160511550-18">}</span><span class="w">
    </span><span class="k" data-group-id="5160511550-9">end</span><span class="w">
  </span><span class="k" data-group-id="5160511550-7">end</span></code></pre><h4 id="-decode-signing-certificate">
Decode Signing Certificate</h4><p>
The certificate we get from Amazon has a lot of information beside the public key we need to validate the message signature.
Luckily, Erlang provides standard library functions for decoding and verifying.
Unfortunately, this process makes heavy use of Erlang records, which don’t have first-class support in Elixir.</p><p>
Let’s begin by creating macros for the records we’ll need to destructure.
This code, like all of the functions we’ve defined so far, goes inside the controller module.</p><pre><code class="makeup elixir"><span class="w">  </span><span class="kn">require</span><span class="w"> </span><span class="nc">Record</span><span class="w">

  </span><span class="nc">Record</span><span class="o">.</span><span class="n">defrecord</span><span class="p" data-group-id="9448257041-1">(</span><span class="w">
    </span><span class="ss">:otp_certificate</span><span class="p">,</span><span class="w">
    </span><span class="nc">Record</span><span class="o">.</span><span class="n">extract</span><span class="p" data-group-id="9448257041-2">(</span><span class="ss">:OTPCertificate</span><span class="p">,</span><span class="w"> </span><span class="ss">from_lib</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;public_key/include/public_key.hrl&quot;</span><span class="p" data-group-id="9448257041-2">)</span><span class="w">
  </span><span class="p" data-group-id="9448257041-1">)</span><span class="w">

  </span><span class="nc">Record</span><span class="o">.</span><span class="n">defrecord</span><span class="p" data-group-id="9448257041-3">(</span><span class="w">
    </span><span class="ss">:otp_tbs_certificate</span><span class="p">,</span><span class="w">
    </span><span class="nc">Record</span><span class="o">.</span><span class="n">extract</span><span class="p" data-group-id="9448257041-4">(</span><span class="ss">:OTPTBSCertificate</span><span class="p">,</span><span class="w"> </span><span class="ss">from_lib</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;public_key/include/public_key.hrl&quot;</span><span class="p" data-group-id="9448257041-4">)</span><span class="w">
  </span><span class="p" data-group-id="9448257041-3">)</span><span class="w">

  </span><span class="nc">Record</span><span class="o">.</span><span class="n">defrecord</span><span class="p" data-group-id="9448257041-5">(</span><span class="w">
    </span><span class="ss">:otp_subject_public_key_info</span><span class="p">,</span><span class="w">
    </span><span class="nc">Record</span><span class="o">.</span><span class="n">extract</span><span class="p" data-group-id="9448257041-6">(</span><span class="ss">:OTPSubjectPublicKeyInfo</span><span class="p">,</span><span class="w"> </span><span class="ss">from_lib</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;public_key/include/public_key.hrl&quot;</span><span class="p" data-group-id="9448257041-6">)</span><span class="w">
  </span><span class="p" data-group-id="9448257041-5">)</span></code></pre><p>
These records work from outside-in.
When using the <code class="inline">:otp</code> mode to decode the certificate, the information we want is inside an <code class="inline">OTPCertificate</code>, <code class="inline">OTPTBSCertificate</code>, and <code class="inline">OTPSubjectPublicKeyInfo</code> record.
In Erlang, we would access the public key using:</p><pre><code class="makeup erlang"><span class="n">Cert</span><span class="o">#</span><span class="ss">&#39;OTPCertificate&#39;</span><span class="p">.</span><span class="ss">tbsCertificate</span><span class="o">#</span><span class="ss">&#39;OTPTBSCertificate&#39;</span><span class="p">.</span><span class="ss">subjectPublicKeyInfo</span><span class="o">#</span><span class="ss">&#39;OTPSubjectPublicKeyInfo&#39;</span><span class="p">.</span><span class="ss">subjectPublicKey</span></code></pre><p>
Luckily, once we generate the helper macros, we can do this in a pipeline:</p><pre><code class="makeup elixir"><span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">decode_signing_cert</span><span class="p" data-group-id="6614600823-1">(</span><span class="n">binary</span><span class="p" data-group-id="6614600823-1">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="6614600823-2">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="nc">:public_key</span><span class="o">.</span><span class="n">public_key</span><span class="p" data-group-id="6614600823-3">(</span><span class="p" data-group-id="6614600823-3">)</span><span class="p" data-group-id="6614600823-2">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="6614600823-4">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="6614600823-5">(</span><span class="p" data-group-id="6614600823-5">)</span><span class="p" data-group-id="6614600823-4">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">decode_signing_cert</span><span class="p" data-group-id="6614600823-6">(</span><span class="n">cert</span><span class="p" data-group-id="6614600823-6">)</span><span class="w"> </span><span class="k" data-group-id="6614600823-7">do</span><span class="w">
    </span><span class="nc">:public_key</span><span class="o">.</span><span class="n">pem_decode</span><span class="p" data-group-id="6614600823-8">(</span><span class="n">cert</span><span class="p" data-group-id="6614600823-8">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">then</span><span class="p" data-group-id="6614600823-9">(</span><span class="o">&amp;</span><span class="nc">:lists</span><span class="o">.</span><span class="n">keysearch</span><span class="p" data-group-id="6614600823-10">(</span><span class="ss">:Certificate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ni">&amp;1</span><span class="p" data-group-id="6614600823-10">)</span><span class="p" data-group-id="6614600823-9">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">then</span><span class="p" data-group-id="6614600823-11">(</span><span class="k" data-group-id="6614600823-12">fn</span><span class="w"> </span><span class="p" data-group-id="6614600823-13">{</span><span class="ss">:value</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6614600823-14">{</span><span class="ss">:Certificate</span><span class="p">,</span><span class="w"> </span><span class="n">cert</span><span class="p">,</span><span class="w"> </span><span class="ss">:not_encrypted</span><span class="p" data-group-id="6614600823-14">}</span><span class="p" data-group-id="6614600823-13">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cert</span><span class="w"> </span><span class="k" data-group-id="6614600823-12">end</span><span class="p" data-group-id="6614600823-11">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">:public_key</span><span class="o">.</span><span class="n">pkix_decode_cert</span><span class="p" data-group-id="6614600823-15">(</span><span class="ss">:otp</span><span class="p" data-group-id="6614600823-15">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">otp_certificate</span><span class="p" data-group-id="6614600823-16">(</span><span class="ss">:tbsCertificate</span><span class="p" data-group-id="6614600823-16">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">otp_tbs_certificate</span><span class="p" data-group-id="6614600823-17">(</span><span class="ss">:subjectPublicKeyInfo</span><span class="p" data-group-id="6614600823-17">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">otp_subject_public_key_info</span><span class="p" data-group-id="6614600823-18">(</span><span class="ss">:subjectPublicKey</span><span class="p" data-group-id="6614600823-18">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">then</span><span class="p" data-group-id="6614600823-19">(</span><span class="o">&amp;</span><span class="p" data-group-id="6614600823-20">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ni">&amp;1</span><span class="p" data-group-id="6614600823-20">}</span><span class="p" data-group-id="6614600823-19">)</span><span class="w">
  </span><span class="k" data-group-id="6614600823-7">rescue</span><span class="w">
    </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="6614600823-21">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to decode signing certificate&quot;</span><span class="p" data-group-id="6614600823-21">}</span><span class="w">
  </span><span class="k" data-group-id="6614600823-7">end</span></code></pre><p>
This function is particularly dense.
If you’re curious, check out the documentation (and source!) for the Erlang <code class="inline">public_key:pem_decode/1</code> and <code class="inline">public_key:pkix_decode_cert/2</code> functions.
Reading through it gave me an appreciation for the technical details involved in asymmetric cryptography, which we sometimes take for granted.</p><p>
It’s slightly lazy to use a generic <code class="inline">rescue</code> in this way, but there are many different things that can go wrong during this decoding process if we are presented with a certificate that does not conform to our narrow expectations.
Rescue, and move on.</p><h3 id="-hash-algorithm-and-signature">
Hash Algorithm and Signature</h3><p>
As if this process weren’t involved enough, messages may use one of two different hashing algorithms (SHA-1 and SHA-256) depending on their <code class="inline">SignatureVersion</code>.</p><p><strong>Note</strong>: It is recommended by Amazon to set the signature version of the topic to <code class="inline">&quot;2&quot;</code> for enhanced security.</p><p>
Translating the signature version is simple, but first we have to browse through a few levels of Erlang type definitions to find the right atoms to use (starting with the spec for <code class="inline">public_key:verify/4</code>).</p><pre><code class="makeup elixir"><span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">get_hash_algorithm</span><span class="p" data-group-id="5993897656-1">(</span><span class="n">integer</span><span class="p" data-group-id="5993897656-1">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="5993897656-2">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">:sha</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:sha256</span><span class="p" data-group-id="5993897656-2">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="5993897656-3">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="5993897656-4">(</span><span class="p" data-group-id="5993897656-4">)</span><span class="p" data-group-id="5993897656-3">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">get_hash_algorithm</span><span class="p" data-group-id="5993897656-5">(</span><span class="s">&quot;1&quot;</span><span class="p" data-group-id="5993897656-5">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5993897656-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">:sha</span><span class="p" data-group-id="5993897656-6">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">get_hash_algorithm</span><span class="p" data-group-id="5993897656-7">(</span><span class="s">&quot;2&quot;</span><span class="p" data-group-id="5993897656-7">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5993897656-8">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">:sha256</span><span class="p" data-group-id="5993897656-8">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">get_hash_algorithm</span><span class="p" data-group-id="5993897656-9">(</span><span class="bp">_</span><span class="p" data-group-id="5993897656-9">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5993897656-10">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unsupported signature version&quot;</span><span class="p" data-group-id="5993897656-10">}</span></code></pre><p>
Our signature needs to be decoded from base-64 before being passed to the verification:</p><pre><code class="makeup elixir"><span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">decode_signature</span><span class="p" data-group-id="7453436850-1">(</span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="7453436850-2">(</span><span class="p" data-group-id="7453436850-2">)</span><span class="p" data-group-id="7453436850-1">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="7453436850-3">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">binary</span><span class="p" data-group-id="7453436850-3">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="7453436850-4">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="7453436850-5">(</span><span class="p" data-group-id="7453436850-5">)</span><span class="p" data-group-id="7453436850-4">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">decode_signature</span><span class="p" data-group-id="7453436850-6">(</span><span class="n">signature</span><span class="p" data-group-id="7453436850-6">)</span><span class="w"> </span><span class="k" data-group-id="7453436850-7">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Base</span><span class="o">.</span><span class="n">decode64</span><span class="p" data-group-id="7453436850-8">(</span><span class="n">signature</span><span class="p" data-group-id="7453436850-8">)</span><span class="w"> </span><span class="k" data-group-id="7453436850-9">do</span><span class="w">
      </span><span class="p" data-group-id="7453436850-10">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">decoded_signature</span><span class="p" data-group-id="7453436850-10">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="7453436850-11">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">decoded_signature</span><span class="p" data-group-id="7453436850-11">}</span><span class="w">
      </span><span class="ss">:error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="7453436850-12">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid signature format&quot;</span><span class="p" data-group-id="7453436850-12">}</span><span class="w">
    </span><span class="k" data-group-id="7453436850-9">end</span><span class="w">
  </span><span class="k" data-group-id="7453436850-7">end</span></code></pre><p>
Now we have all of the data we need to run the verification.</p><h3 id="-verify-the-signature">
Verify the Signature</h3><p>
Everything we’ve done so far has been an elaborate preparation for a single function call:</p><pre><code class="makeup elixir"><span class="nc">:public_key</span><span class="o">.</span><span class="n">verify</span><span class="p" data-group-id="6068981198-1">(</span><span class="n">string_to_sign</span><span class="p">,</span><span class="w"> </span><span class="n">hash_algorithm</span><span class="p">,</span><span class="w"> </span><span class="n">decoded_signature</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="6068981198-1">)</span></code></pre><p>
It returns a simple <code class="inline">true</code> or <code class="inline">false</code> response for our troubles.
Calling this function is preferred because it works with several different key types without additional processing.
Erlang’s <code class="inline">crypto:verify/5</code> is also available, but we would have to detect the key type and extract its data.</p><p>
If the message is valid, we continue.
Otherwise, we can immediately return an error.</p><h2 id="-handle-management-messages">
Handle Management Messages</h2><p>
SNS has two message types, <code class="inline">SubscriptionConfirmation</code> and <code class="inline">UnsubscribeConfirmation</code>, that should not be processed by our normal message handlers.
For these, we will take any necessary action, and return <code class="inline">{:ignore, ...}</code> to escape processing early.</p><pre><code class="makeup elixir"><span class="w">  </span><span class="na">@spec</span><span class="w"> </span><span class="n">handle_management_messages</span><span class="p" data-group-id="2382672575-1">(</span><span class="n">map</span><span class="p" data-group-id="2382672575-1">)</span><span class="w"> </span><span class="o">::</span><span class="w">
          </span><span class="ss">:ok</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="2382672575-2">{</span><span class="ss">:ignore</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="2382672575-3">(</span><span class="p" data-group-id="2382672575-3">)</span><span class="p" data-group-id="2382672575-2">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="2382672575-4">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">atom</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="2382672575-5">(</span><span class="p" data-group-id="2382672575-5">)</span><span class="p" data-group-id="2382672575-4">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">handle_management_messages</span><span class="p" data-group-id="2382672575-6">(</span><span class="n">message</span><span class="p" data-group-id="2382672575-6">)</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">handle_management_messages</span><span class="p" data-group-id="2382672575-7">(</span><span class="p" data-group-id="2382672575-8">%{</span><span class="s">&quot;Type&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;UnsubscribeConfirmation&quot;</span><span class="p" data-group-id="2382672575-8">}</span><span class="p" data-group-id="2382672575-7">)</span><span class="w"> </span><span class="k" data-group-id="2382672575-9">do</span><span class="w">
    </span><span class="p" data-group-id="2382672575-10">{</span><span class="ss">:ignore</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unsubscribe confirmation; not a notification&quot;</span><span class="p" data-group-id="2382672575-10">}</span><span class="w">
  </span><span class="k" data-group-id="2382672575-9">end</span></code></pre><p>
There’s generally no action necessary when receiving an unsubscribe confirmation.
We have a little more work to do for subscription confirmations, however.
SNS requires subscriptions are <a href="https://docs.aws.amazon.com/sns/latest/dg/SendMessageToHttp.confirm.html">confirmed</a> by clicking a link in the message.
We should only do this if the SNS topic matches one that we want to subscribe to; otherwise, someone can subscribe our application to a real SNS topic that they control.</p><pre><code class="makeup elixir"><span class="w">  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">handle_management_messages</span><span class="p" data-group-id="0520235251-1">(</span><span class="p" data-group-id="0520235251-2">%{</span><span class="s">&quot;Type&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;SubscriptionConfirmation&quot;</span><span class="p" data-group-id="0520235251-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="0520235251-1">)</span><span class="w"> </span><span class="k" data-group-id="0520235251-3">do</span><span class="w">
    </span><span class="c1"># TODO: Check if the `Topic` is one we care about.</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Req</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="0520235251-4">(</span><span class="n">message</span><span class="p" data-group-id="0520235251-5">[</span><span class="s">&quot;SubscribeURL&quot;</span><span class="p" data-group-id="0520235251-5">]</span><span class="p" data-group-id="0520235251-4">)</span><span class="w"> </span><span class="k" data-group-id="0520235251-6">do</span><span class="w">
      </span><span class="p" data-group-id="0520235251-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0520235251-8">%</span><span class="nc" data-group-id="0520235251-8">Req.Response</span><span class="p" data-group-id="0520235251-8">{</span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p" data-group-id="0520235251-8">}</span><span class="p" data-group-id="0520235251-7">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="0520235251-9">{</span><span class="ss">:ignore</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Subscription confirmation; not a notification&quot;</span><span class="p" data-group-id="0520235251-9">}</span><span class="w">

      </span><span class="p" data-group-id="0520235251-10">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0520235251-11">%</span><span class="nc" data-group-id="0520235251-11">Req.Response</span><span class="p" data-group-id="0520235251-11">{</span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="n">status</span><span class="p" data-group-id="0520235251-11">}</span><span class="p" data-group-id="0520235251-10">}</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mi">400</span><span class="o">..</span><span class="mi">599</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="0520235251-12">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:bad_request</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to confirm subscription: HTTP </span><span class="si" data-group-id="0520235251-13">#{</span><span class="n">status</span><span class="si" data-group-id="0520235251-13">}</span><span class="s">&quot;</span><span class="p" data-group-id="0520235251-12">}</span><span class="w">

      </span><span class="p" data-group-id="0520235251-14">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="0520235251-14">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="0520235251-15">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:internal_server_error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to confirm subscription: </span><span class="si" data-group-id="0520235251-16">#{</span><span class="n">inspect</span><span class="p" data-group-id="0520235251-17">(</span><span class="n">reason</span><span class="p" data-group-id="0520235251-17">)</span><span class="si" data-group-id="0520235251-16">}</span><span class="s">&quot;</span><span class="p" data-group-id="0520235251-15">}</span><span class="w">
    </span><span class="k" data-group-id="0520235251-6">end</span><span class="w">
  </span><span class="k" data-group-id="0520235251-3">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">handle_management_messages</span><span class="p" data-group-id="0520235251-18">(</span><span class="c">_params</span><span class="p" data-group-id="0520235251-18">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="ss">:ok</span></code></pre><p>
These additional clauses visit the confirmation URL, if necessary, or simply continue processing of the message for regular notifications.</p><h2 id="-other-considerations">
Other Considerations</h2><p>
Above we note that we should only perform subscription confirmations when we recognize the SNS topic.
Another way to address the issue of potentially receiving subscription confirmations from unknown topics is with HTTP Basic Auth.
SNS supports providing a username / password combination to include in message deliveries.
Meanwhile, Plug provides <a href="https://hexdocs.pm/plug/Plug.BasicAuth.html"><code class="inline">Plug.BasicAuth</code></a> to help us integrate this into our application.</p><p><strong>Warning</strong>: It is recommended to use runtime confirmation for authentication secrets like this.
As a result, we need to use the indirect approach documented <a href="https://hexdocs.pm/plug/Plug.BasicAuth.html#module-runtime-time-usage">here</a>.</p><h2 id="-putting-it-all-together">
Putting it all Together</h2><p>
Here’s the complete module:</p><pre><code class="makeup elixir"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyAppWeb.SNSController</span><span class="w"> </span><span class="k" data-group-id="1529580406-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Phoenix.Controller</span><span class="p">,</span><span class="w"> </span><span class="ss">formats</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1529580406-2">[</span><span class="ss">:json</span><span class="p" data-group-id="1529580406-2">]</span><span class="w">
  </span><span class="kn">import</span><span class="w"> </span><span class="nc">Plug.Conn</span><span class="w">

  </span><span class="n">action_fallback</span><span class="w"> </span><span class="ss">:fallback</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">notification</span><span class="p" data-group-id="1529580406-3">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="1529580406-3">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-4">do</span><span class="w">
    </span><span class="k">with</span><span class="w"> </span><span class="ss">:ok</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">verify_message</span><span class="p" data-group-id="1529580406-5">(</span><span class="n">params</span><span class="p" data-group-id="1529580406-5">)</span><span class="p">,</span><span class="w">
         </span><span class="ss">:ok</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">handle_management_messages</span><span class="p" data-group-id="1529580406-6">(</span><span class="n">params</span><span class="p" data-group-id="1529580406-6">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-7">do</span><span class="w">
      </span><span class="c1"># Handle message here.</span><span class="w">
      </span><span class="n">send_resp</span><span class="p" data-group-id="1529580406-8">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p" data-group-id="1529580406-8">)</span><span class="w">
    </span><span class="k" data-group-id="1529580406-7">end</span><span class="w">
  </span><span class="k" data-group-id="1529580406-4">end</span><span class="w">

  </span><span class="c1">#</span><span class="w">
  </span><span class="c1"># Fallback</span><span class="w">
  </span><span class="c1">#</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="no">false</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">fallback</span><span class="p" data-group-id="1529580406-9">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1529580406-10">{</span><span class="ss">:ignore</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1529580406-10">}</span><span class="p" data-group-id="1529580406-9">)</span><span class="w">
      </span><span class="ow">when</span><span class="w"> </span><span class="n">is_binary</span><span class="p" data-group-id="1529580406-11">(</span><span class="n">reason</span><span class="p" data-group-id="1529580406-11">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">send_resp</span><span class="p" data-group-id="1529580406-12">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1529580406-12">)</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">fallback</span><span class="p" data-group-id="1529580406-13">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1529580406-14">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1529580406-14">}</span><span class="p" data-group-id="1529580406-13">)</span><span class="w">
      </span><span class="ow">when</span><span class="w"> </span><span class="n">is_atom</span><span class="p" data-group-id="1529580406-15">(</span><span class="n">code</span><span class="p" data-group-id="1529580406-15">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">is_binary</span><span class="p" data-group-id="1529580406-16">(</span><span class="n">reason</span><span class="p" data-group-id="1529580406-16">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">send_resp</span><span class="p" data-group-id="1529580406-17">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1529580406-17">)</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">fallback</span><span class="p" data-group-id="1529580406-18">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1529580406-19">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1529580406-19">}</span><span class="p" data-group-id="1529580406-18">)</span><span class="w">
      </span><span class="ow">when</span><span class="w"> </span><span class="n">is_binary</span><span class="p" data-group-id="1529580406-20">(</span><span class="n">reason</span><span class="p" data-group-id="1529580406-20">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">send_resp</span><span class="p" data-group-id="1529580406-21">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:internal_server_error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1529580406-21">)</span><span class="w">

  </span><span class="c1">#</span><span class="w">
  </span><span class="c1"># Verify</span><span class="w">
  </span><span class="c1">#</span><span class="w">

  </span><span class="kn">require</span><span class="w"> </span><span class="nc">Record</span><span class="w">

  </span><span class="nc">Record</span><span class="o">.</span><span class="n">defrecord</span><span class="p" data-group-id="1529580406-22">(</span><span class="w">
    </span><span class="ss">:otp_certificate</span><span class="p">,</span><span class="w">
    </span><span class="nc">Record</span><span class="o">.</span><span class="n">extract</span><span class="p" data-group-id="1529580406-23">(</span><span class="ss">:OTPCertificate</span><span class="p">,</span><span class="w"> </span><span class="ss">from_lib</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;public_key/include/public_key.hrl&quot;</span><span class="p" data-group-id="1529580406-23">)</span><span class="w">
  </span><span class="p" data-group-id="1529580406-22">)</span><span class="w">

  </span><span class="nc">Record</span><span class="o">.</span><span class="n">defrecord</span><span class="p" data-group-id="1529580406-24">(</span><span class="w">
    </span><span class="ss">:otp_tbs_certificate</span><span class="p">,</span><span class="w">
    </span><span class="nc">Record</span><span class="o">.</span><span class="n">extract</span><span class="p" data-group-id="1529580406-25">(</span><span class="ss">:OTPTBSCertificate</span><span class="p">,</span><span class="w"> </span><span class="ss">from_lib</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;public_key/include/public_key.hrl&quot;</span><span class="p" data-group-id="1529580406-25">)</span><span class="w">
  </span><span class="p" data-group-id="1529580406-24">)</span><span class="w">

  </span><span class="nc">Record</span><span class="o">.</span><span class="n">defrecord</span><span class="p" data-group-id="1529580406-26">(</span><span class="w">
    </span><span class="ss">:otp_subject_public_key_info</span><span class="p">,</span><span class="w">
    </span><span class="nc">Record</span><span class="o">.</span><span class="n">extract</span><span class="p" data-group-id="1529580406-27">(</span><span class="ss">:OTPSubjectPublicKeyInfo</span><span class="p">,</span><span class="w"> </span><span class="ss">from_lib</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;public_key/include/public_key.hrl&quot;</span><span class="p" data-group-id="1529580406-27">)</span><span class="w">
  </span><span class="p" data-group-id="1529580406-26">)</span><span class="w">

  </span><span class="na">@spec</span><span class="w"> </span><span class="n">verify_message</span><span class="p" data-group-id="1529580406-28">(</span><span class="n">map</span><span class="p" data-group-id="1529580406-28">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="ss">:ok</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="1529580406-29">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-30">(</span><span class="p" data-group-id="1529580406-30">)</span><span class="p" data-group-id="1529580406-29">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">verify_message</span><span class="p" data-group-id="1529580406-31">(</span><span class="n">message</span><span class="p" data-group-id="1529580406-31">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-32">do</span><span class="w">
    </span><span class="n">string_to_sign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">construct_signed_string</span><span class="p" data-group-id="1529580406-33">(</span><span class="n">message</span><span class="p" data-group-id="1529580406-33">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w">

    </span><span class="k">with</span><span class="w"> </span><span class="p" data-group-id="1529580406-34">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="1529580406-34">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_public_key</span><span class="p" data-group-id="1529580406-35">(</span><span class="n">message</span><span class="p" data-group-id="1529580406-36">[</span><span class="s">&quot;SigningCertURL&quot;</span><span class="p" data-group-id="1529580406-36">]</span><span class="p" data-group-id="1529580406-35">)</span><span class="p">,</span><span class="w">
         </span><span class="p" data-group-id="1529580406-37">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">hash_algorithm</span><span class="p" data-group-id="1529580406-37">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_hash_algorithm</span><span class="p" data-group-id="1529580406-38">(</span><span class="n">message</span><span class="p" data-group-id="1529580406-39">[</span><span class="s">&quot;SignatureVersion&quot;</span><span class="p" data-group-id="1529580406-39">]</span><span class="p" data-group-id="1529580406-38">)</span><span class="p">,</span><span class="w">
         </span><span class="p" data-group-id="1529580406-40">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">decoded_signature</span><span class="p" data-group-id="1529580406-40">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">decode_signature</span><span class="p" data-group-id="1529580406-41">(</span><span class="n">message</span><span class="p" data-group-id="1529580406-42">[</span><span class="s">&quot;Signature&quot;</span><span class="p" data-group-id="1529580406-42">]</span><span class="p" data-group-id="1529580406-41">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-43">do</span><span class="w">
      </span><span class="k">if</span><span class="w"> </span><span class="nc">:public_key</span><span class="o">.</span><span class="n">verify</span><span class="p" data-group-id="1529580406-44">(</span><span class="n">string_to_sign</span><span class="p">,</span><span class="w"> </span><span class="n">hash_algorithm</span><span class="p">,</span><span class="w"> </span><span class="n">decoded_signature</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="1529580406-44">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-45">do</span><span class="w">
        </span><span class="ss">:ok</span><span class="w">
      </span><span class="k" data-group-id="1529580406-45">else</span><span class="w">
        </span><span class="p" data-group-id="1529580406-46">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Signature verification failed&quot;</span><span class="p" data-group-id="1529580406-46">}</span><span class="w">
      </span><span class="k" data-group-id="1529580406-45">end</span><span class="w">
    </span><span class="k" data-group-id="1529580406-43">end</span><span class="w">
  </span><span class="k" data-group-id="1529580406-32">end</span><span class="w">

  </span><span class="na">@spec</span><span class="w"> </span><span class="n">construct_signed_string</span><span class="p" data-group-id="1529580406-47">(</span><span class="n">map</span><span class="p" data-group-id="1529580406-47">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-48">(</span><span class="p" data-group-id="1529580406-48">)</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">construct_signed_string</span><span class="p" data-group-id="1529580406-49">(</span><span class="n">message</span><span class="p" data-group-id="1529580406-49">)</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">construct_signed_string</span><span class="p" data-group-id="1529580406-50">(</span><span class="p" data-group-id="1529580406-51">%{</span><span class="s">&quot;Type&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;Notification&quot;</span><span class="p" data-group-id="1529580406-51">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="1529580406-50">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-52">do</span><span class="w">
    </span><span class="n">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="1529580406-53">[</span><span class="s">&quot;Subject&quot;</span><span class="p" data-group-id="1529580406-53">]</span><span class="w">

    </span><span class="p" data-group-id="1529580406-54">[</span><span class="w">
      </span><span class="s">&quot;Message&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="1529580406-55">[</span><span class="s">&quot;Message&quot;</span><span class="p" data-group-id="1529580406-55">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;MessageId&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="1529580406-56">[</span><span class="s">&quot;MessageId&quot;</span><span class="p" data-group-id="1529580406-56">]</span><span class="p">,</span><span class="w">
      </span><span class="k">if</span><span class="p" data-group-id="1529580406-57">(</span><span class="n">subject</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Subject&quot;</span><span class="p" data-group-id="1529580406-57">)</span><span class="p">,</span><span class="w">
      </span><span class="k">if</span><span class="p" data-group-id="1529580406-58">(</span><span class="n">subject</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="n">subject</span><span class="p" data-group-id="1529580406-58">)</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;Timestamp&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="1529580406-59">[</span><span class="s">&quot;Timestamp&quot;</span><span class="p" data-group-id="1529580406-59">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;TopicArn&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="1529580406-60">[</span><span class="s">&quot;TopicArn&quot;</span><span class="p" data-group-id="1529580406-60">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;Type&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="1529580406-61">[</span><span class="s">&quot;Type&quot;</span><span class="p" data-group-id="1529580406-61">]</span><span class="w">
    </span><span class="p" data-group-id="1529580406-54">]</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reject</span><span class="p" data-group-id="1529580406-62">(</span><span class="o">&amp;</span><span class="n">is_nil</span><span class="o">/</span><span class="mi">1</span><span class="p" data-group-id="1529580406-62">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="1529580406-63">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p" data-group-id="1529580406-63">)</span><span class="w">
  </span><span class="k" data-group-id="1529580406-52">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">construct_signed_string</span><span class="p" data-group-id="1529580406-64">(</span><span class="n">message</span><span class="p" data-group-id="1529580406-64">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-65">do</span><span class="w">
    </span><span class="p" data-group-id="1529580406-66">[</span><span class="w">
      </span><span class="s">&quot;Message&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="1529580406-67">[</span><span class="s">&quot;Message&quot;</span><span class="p" data-group-id="1529580406-67">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;MessageId&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="1529580406-68">[</span><span class="s">&quot;MessageId&quot;</span><span class="p" data-group-id="1529580406-68">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;SubscribeURL&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="1529580406-69">[</span><span class="s">&quot;SubscribeURL&quot;</span><span class="p" data-group-id="1529580406-69">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;Timestamp&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="1529580406-70">[</span><span class="s">&quot;Timestamp&quot;</span><span class="p" data-group-id="1529580406-70">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;Token&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="1529580406-71">[</span><span class="s">&quot;Token&quot;</span><span class="p" data-group-id="1529580406-71">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;TopicArn&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="1529580406-72">[</span><span class="s">&quot;TopicArn&quot;</span><span class="p" data-group-id="1529580406-72">]</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;Type&quot;</span><span class="p">,</span><span class="w">
      </span><span class="n">message</span><span class="p" data-group-id="1529580406-73">[</span><span class="s">&quot;Type&quot;</span><span class="p" data-group-id="1529580406-73">]</span><span class="w">
    </span><span class="p" data-group-id="1529580406-66">]</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="1529580406-74">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p" data-group-id="1529580406-74">)</span><span class="w">
  </span><span class="k" data-group-id="1529580406-65">end</span><span class="w">

  </span><span class="na">@spec</span><span class="w"> </span><span class="n">get_public_key</span><span class="p" data-group-id="1529580406-75">(</span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-76">(</span><span class="p" data-group-id="1529580406-76">)</span><span class="p" data-group-id="1529580406-75">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="1529580406-77">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="nc">:public_key</span><span class="o">.</span><span class="n">public_key</span><span class="p" data-group-id="1529580406-78">(</span><span class="p" data-group-id="1529580406-78">)</span><span class="p" data-group-id="1529580406-77">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="1529580406-79">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-80">(</span><span class="p" data-group-id="1529580406-80">)</span><span class="p" data-group-id="1529580406-79">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">get_public_key</span><span class="p" data-group-id="1529580406-81">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="1529580406-81">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-82">do</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:persistent_term</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="1529580406-83">(</span><span class="p" data-group-id="1529580406-84">{</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">signing_cert_url</span><span class="p" data-group-id="1529580406-84">}</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="1529580406-83">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-85">do</span><span class="w">
      </span><span class="p" data-group-id="1529580406-86">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="1529580406-86">}</span><span class="w">
    </span><span class="k" data-group-id="1529580406-85">else</span><span class="w">
      </span><span class="k">with</span><span class="w"> </span><span class="ss">:ok</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">validate_signing_cert_url</span><span class="p" data-group-id="1529580406-87">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="1529580406-87">)</span><span class="p">,</span><span class="w">
           </span><span class="p" data-group-id="1529580406-88">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">cert</span><span class="p" data-group-id="1529580406-88">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">download_signing_cert</span><span class="p" data-group-id="1529580406-89">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="1529580406-89">)</span><span class="p">,</span><span class="w">
           </span><span class="p" data-group-id="1529580406-90">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="1529580406-90">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">decode_signing_cert</span><span class="p" data-group-id="1529580406-91">(</span><span class="n">cert</span><span class="p" data-group-id="1529580406-91">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-92">do</span><span class="w">
        </span><span class="nc">:persistent_term</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="1529580406-93">(</span><span class="p" data-group-id="1529580406-94">{</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">signing_cert_url</span><span class="p" data-group-id="1529580406-94">}</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="1529580406-93">)</span><span class="w">
        </span><span class="p" data-group-id="1529580406-95">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="1529580406-95">}</span><span class="w">
      </span><span class="k" data-group-id="1529580406-92">end</span><span class="w">
    </span><span class="k" data-group-id="1529580406-85">end</span><span class="w">
  </span><span class="k" data-group-id="1529580406-82">end</span><span class="w">

  </span><span class="na">@spec</span><span class="w"> </span><span class="n">validate_signing_cert_url</span><span class="p" data-group-id="1529580406-96">(</span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-97">(</span><span class="p" data-group-id="1529580406-97">)</span><span class="p" data-group-id="1529580406-96">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="ss">:ok</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="1529580406-98">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-99">(</span><span class="p" data-group-id="1529580406-99">)</span><span class="p" data-group-id="1529580406-98">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">validate_signing_cert_url</span><span class="p" data-group-id="1529580406-100">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="1529580406-100">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-101">do</span><span class="w">
    </span><span class="n">valid_hostname?</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="nc">URI</span><span class="o">.</span><span class="n">parse</span><span class="p" data-group-id="1529580406-102">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="1529580406-102">)</span><span class="o">.</span><span class="n">host</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">match?</span><span class="p" data-group-id="1529580406-103">(</span><span class="sr">~r/sns</span><span class="se">\.</span><span class="sr">[a-zA-z0-9</span><span class="se">\-</span><span class="sr">]+</span><span class="se">\.</span><span class="sr">amazonaws</span><span class="se">\.</span><span class="sr">com/</span><span class="p" data-group-id="1529580406-103">)</span><span class="w">

    </span><span class="k">if</span><span class="w"> </span><span class="n">valid_hostname?</span><span class="w"> </span><span class="k" data-group-id="1529580406-104">do</span><span class="w">
      </span><span class="ss">:ok</span><span class="w">
    </span><span class="k" data-group-id="1529580406-104">else</span><span class="w">
      </span><span class="p" data-group-id="1529580406-105">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid signing certificate URL&quot;</span><span class="p" data-group-id="1529580406-105">}</span><span class="w">
    </span><span class="k" data-group-id="1529580406-104">end</span><span class="w">
  </span><span class="k" data-group-id="1529580406-101">end</span><span class="w">

  </span><span class="na">@spec</span><span class="w"> </span><span class="n">download_signing_cert</span><span class="p" data-group-id="1529580406-106">(</span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-107">(</span><span class="p" data-group-id="1529580406-107">)</span><span class="p" data-group-id="1529580406-106">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="1529580406-108">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">binary</span><span class="p" data-group-id="1529580406-108">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="1529580406-109">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-110">(</span><span class="p" data-group-id="1529580406-110">)</span><span class="p" data-group-id="1529580406-109">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">download_signing_cert</span><span class="p" data-group-id="1529580406-111">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="1529580406-111">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-112">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Req</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="1529580406-113">(</span><span class="n">signing_cert_url</span><span class="p" data-group-id="1529580406-113">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-114">do</span><span class="w">
      </span><span class="p" data-group-id="1529580406-115">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1529580406-116">%</span><span class="nc" data-group-id="1529580406-116">Req.Response</span><span class="p" data-group-id="1529580406-116">{</span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="ss">body</span><span class="p">:</span><span class="w"> </span><span class="n">body</span><span class="p" data-group-id="1529580406-116">}</span><span class="p" data-group-id="1529580406-115">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="1529580406-117">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p" data-group-id="1529580406-117">}</span><span class="w">

      </span><span class="p" data-group-id="1529580406-118">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1529580406-119">%</span><span class="nc" data-group-id="1529580406-119">Req.Response</span><span class="p" data-group-id="1529580406-119">{</span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="n">status</span><span class="p" data-group-id="1529580406-119">}</span><span class="p" data-group-id="1529580406-118">}</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mi">400</span><span class="o">..</span><span class="mi">599</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="1529580406-120">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to fetch signing certificate: HTTP </span><span class="si" data-group-id="1529580406-121">#{</span><span class="n">status</span><span class="si" data-group-id="1529580406-121">}</span><span class="s">&quot;</span><span class="p" data-group-id="1529580406-120">}</span><span class="w">

      </span><span class="p" data-group-id="1529580406-122">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1529580406-122">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="1529580406-123">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to fetch signing certificate: </span><span class="si" data-group-id="1529580406-124">#{</span><span class="n">inspect</span><span class="p" data-group-id="1529580406-125">(</span><span class="n">reason</span><span class="p" data-group-id="1529580406-125">)</span><span class="si" data-group-id="1529580406-124">}</span><span class="s">&quot;</span><span class="p" data-group-id="1529580406-123">}</span><span class="w">
    </span><span class="k" data-group-id="1529580406-114">end</span><span class="w">
  </span><span class="k" data-group-id="1529580406-112">end</span><span class="w">

  </span><span class="na">@spec</span><span class="w"> </span><span class="n">decode_signing_cert</span><span class="p" data-group-id="1529580406-126">(</span><span class="n">binary</span><span class="p" data-group-id="1529580406-126">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="1529580406-127">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="nc">:public_key</span><span class="o">.</span><span class="n">public_key</span><span class="p" data-group-id="1529580406-128">(</span><span class="p" data-group-id="1529580406-128">)</span><span class="p" data-group-id="1529580406-127">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="1529580406-129">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-130">(</span><span class="p" data-group-id="1529580406-130">)</span><span class="p" data-group-id="1529580406-129">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">decode_signing_cert</span><span class="p" data-group-id="1529580406-131">(</span><span class="n">cert</span><span class="p" data-group-id="1529580406-131">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-132">do</span><span class="w">
    </span><span class="nc">:public_key</span><span class="o">.</span><span class="n">pem_decode</span><span class="p" data-group-id="1529580406-133">(</span><span class="n">cert</span><span class="p" data-group-id="1529580406-133">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">then</span><span class="p" data-group-id="1529580406-134">(</span><span class="o">&amp;</span><span class="nc">:lists</span><span class="o">.</span><span class="n">keysearch</span><span class="p" data-group-id="1529580406-135">(</span><span class="ss">:Certificate</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ni">&amp;1</span><span class="p" data-group-id="1529580406-135">)</span><span class="p" data-group-id="1529580406-134">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">then</span><span class="p" data-group-id="1529580406-136">(</span><span class="k" data-group-id="1529580406-137">fn</span><span class="w"> </span><span class="p" data-group-id="1529580406-138">{</span><span class="ss">:value</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1529580406-139">{</span><span class="ss">:Certificate</span><span class="p">,</span><span class="w"> </span><span class="n">cert</span><span class="p">,</span><span class="w"> </span><span class="ss">:not_encrypted</span><span class="p" data-group-id="1529580406-139">}</span><span class="p" data-group-id="1529580406-138">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cert</span><span class="w"> </span><span class="k" data-group-id="1529580406-137">end</span><span class="p" data-group-id="1529580406-136">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">:public_key</span><span class="o">.</span><span class="n">pkix_decode_cert</span><span class="p" data-group-id="1529580406-140">(</span><span class="ss">:otp</span><span class="p" data-group-id="1529580406-140">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">otp_certificate</span><span class="p" data-group-id="1529580406-141">(</span><span class="ss">:tbsCertificate</span><span class="p" data-group-id="1529580406-141">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">otp_tbs_certificate</span><span class="p" data-group-id="1529580406-142">(</span><span class="ss">:subjectPublicKeyInfo</span><span class="p" data-group-id="1529580406-142">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">otp_subject_public_key_info</span><span class="p" data-group-id="1529580406-143">(</span><span class="ss">:subjectPublicKey</span><span class="p" data-group-id="1529580406-143">)</span><span class="w">
    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">then</span><span class="p" data-group-id="1529580406-144">(</span><span class="o">&amp;</span><span class="p" data-group-id="1529580406-145">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ni">&amp;1</span><span class="p" data-group-id="1529580406-145">}</span><span class="p" data-group-id="1529580406-144">)</span><span class="w">
  </span><span class="k" data-group-id="1529580406-132">rescue</span><span class="w">
    </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="p" data-group-id="1529580406-146">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to decode signing certificate&quot;</span><span class="p" data-group-id="1529580406-146">}</span><span class="w">
  </span><span class="k" data-group-id="1529580406-132">end</span><span class="w">

  </span><span class="na">@spec</span><span class="w"> </span><span class="n">get_hash_algorithm</span><span class="p" data-group-id="1529580406-147">(</span><span class="n">integer</span><span class="p" data-group-id="1529580406-147">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="1529580406-148">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">:sha</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">:sha256</span><span class="p" data-group-id="1529580406-148">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="1529580406-149">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-150">(</span><span class="p" data-group-id="1529580406-150">)</span><span class="p" data-group-id="1529580406-149">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">get_hash_algorithm</span><span class="p" data-group-id="1529580406-151">(</span><span class="s">&quot;1&quot;</span><span class="p" data-group-id="1529580406-151">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1529580406-152">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">:sha</span><span class="p" data-group-id="1529580406-152">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">get_hash_algorithm</span><span class="p" data-group-id="1529580406-153">(</span><span class="s">&quot;2&quot;</span><span class="p" data-group-id="1529580406-153">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1529580406-154">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="ss">:sha256</span><span class="p" data-group-id="1529580406-154">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">get_hash_algorithm</span><span class="p" data-group-id="1529580406-155">(</span><span class="bp">_</span><span class="p" data-group-id="1529580406-155">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1529580406-156">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unsupported signature version&quot;</span><span class="p" data-group-id="1529580406-156">}</span><span class="w">

  </span><span class="na">@spec</span><span class="w"> </span><span class="n">decode_signature</span><span class="p" data-group-id="1529580406-157">(</span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-158">(</span><span class="p" data-group-id="1529580406-158">)</span><span class="p" data-group-id="1529580406-157">)</span><span class="w"> </span><span class="o">::</span><span class="w"> </span><span class="p" data-group-id="1529580406-159">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">binary</span><span class="p" data-group-id="1529580406-159">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="1529580406-160">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-161">(</span><span class="p" data-group-id="1529580406-161">)</span><span class="p" data-group-id="1529580406-160">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">decode_signature</span><span class="p" data-group-id="1529580406-162">(</span><span class="n">signature</span><span class="p" data-group-id="1529580406-162">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-163">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Base</span><span class="o">.</span><span class="n">decode64</span><span class="p" data-group-id="1529580406-164">(</span><span class="n">signature</span><span class="p" data-group-id="1529580406-164">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-165">do</span><span class="w">
      </span><span class="p" data-group-id="1529580406-166">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">decoded_signature</span><span class="p" data-group-id="1529580406-166">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1529580406-167">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">decoded_signature</span><span class="p" data-group-id="1529580406-167">}</span><span class="w">
      </span><span class="ss">:error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1529580406-168">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Invalid signature format&quot;</span><span class="p" data-group-id="1529580406-168">}</span><span class="w">
    </span><span class="k" data-group-id="1529580406-165">end</span><span class="w">
  </span><span class="k" data-group-id="1529580406-163">end</span><span class="w">

  </span><span class="c1">#</span><span class="w">
  </span><span class="c1"># Confirm Subscription</span><span class="w">
  </span><span class="c1">#</span><span class="w">

  </span><span class="na">@spec</span><span class="w"> </span><span class="n">handle_management_messages</span><span class="p" data-group-id="1529580406-169">(</span><span class="n">map</span><span class="p" data-group-id="1529580406-169">)</span><span class="w"> </span><span class="o">::</span><span class="w">
          </span><span class="ss">:ok</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="1529580406-170">{</span><span class="ss">:ignore</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-171">(</span><span class="p" data-group-id="1529580406-171">)</span><span class="p" data-group-id="1529580406-170">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p" data-group-id="1529580406-172">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">atom</span><span class="p">,</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">t</span><span class="p" data-group-id="1529580406-173">(</span><span class="p" data-group-id="1529580406-173">)</span><span class="p" data-group-id="1529580406-172">}</span><span class="w">
  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">handle_management_messages</span><span class="p" data-group-id="1529580406-174">(</span><span class="p" data-group-id="1529580406-175">%{</span><span class="s">&quot;Type&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;SubscriptionConfirmation&quot;</span><span class="p" data-group-id="1529580406-175">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="1529580406-174">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-176">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Req</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="1529580406-177">(</span><span class="n">message</span><span class="p" data-group-id="1529580406-178">[</span><span class="s">&quot;SubscribeURL&quot;</span><span class="p" data-group-id="1529580406-178">]</span><span class="p" data-group-id="1529580406-177">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-179">do</span><span class="w">
      </span><span class="p" data-group-id="1529580406-180">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1529580406-181">%</span><span class="nc" data-group-id="1529580406-181">Req.Response</span><span class="p" data-group-id="1529580406-181">{</span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p" data-group-id="1529580406-181">}</span><span class="p" data-group-id="1529580406-180">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="1529580406-182">{</span><span class="ss">:ignore</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Subscription confirmation; not a notification&quot;</span><span class="p" data-group-id="1529580406-182">}</span><span class="w">

      </span><span class="p" data-group-id="1529580406-183">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1529580406-184">%</span><span class="nc" data-group-id="1529580406-184">Req.Response</span><span class="p" data-group-id="1529580406-184">{</span><span class="ss">status</span><span class="p">:</span><span class="w"> </span><span class="n">status</span><span class="p" data-group-id="1529580406-184">}</span><span class="p" data-group-id="1529580406-183">}</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mi">400</span><span class="o">..</span><span class="mi">599</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="1529580406-185">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:bad_request</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to confirm subscription: HTTP </span><span class="si" data-group-id="1529580406-186">#{</span><span class="n">status</span><span class="si" data-group-id="1529580406-186">}</span><span class="s">&quot;</span><span class="p" data-group-id="1529580406-185">}</span><span class="w">

      </span><span class="p" data-group-id="1529580406-187">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="1529580406-187">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="1529580406-188">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:internal_server_error</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Failed to confirm subscription: </span><span class="si" data-group-id="1529580406-189">#{</span><span class="n">inspect</span><span class="p" data-group-id="1529580406-190">(</span><span class="n">reason</span><span class="p" data-group-id="1529580406-190">)</span><span class="si" data-group-id="1529580406-189">}</span><span class="s">&quot;</span><span class="p" data-group-id="1529580406-188">}</span><span class="w">
    </span><span class="k" data-group-id="1529580406-179">end</span><span class="w">
  </span><span class="k" data-group-id="1529580406-176">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">handle_management_messages</span><span class="p" data-group-id="1529580406-191">(</span><span class="p" data-group-id="1529580406-192">%{</span><span class="s">&quot;Type&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;UnsubscribeConfirmation&quot;</span><span class="p" data-group-id="1529580406-192">}</span><span class="p" data-group-id="1529580406-191">)</span><span class="w"> </span><span class="k" data-group-id="1529580406-193">do</span><span class="w">
    </span><span class="p" data-group-id="1529580406-194">{</span><span class="ss">:ignore</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Unsubscribe confirmation; not a notification&quot;</span><span class="p" data-group-id="1529580406-194">}</span><span class="w">
  </span><span class="k" data-group-id="1529580406-193">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">handle_management_messages</span><span class="p" data-group-id="1529580406-195">(</span><span class="c">_params</span><span class="p" data-group-id="1529580406-195">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="ss">:ok</span><span class="w">
</span><span class="k" data-group-id="1529580406-1">end</span><span class="w">
</span></code></pre><p>
It’s a lot of processing for this kind of webhook, but also not so much that it requires the creation of a library.
Adding logs is a good idea to help diagnose message verification failures in the future.</p><p>
Remember to set the content type and signature versions on your topics.</p></div>
      </section>
    </div>





    <footer>
      <div class="darkmode">
        <input type="checkbox" id="darkmode">
        <label for="darkmode">Toggle Dark Mode</label>
      </div>
      <div>
        Created with ♥︎ by AJ Foster. <a href="https://github.com/aj-foster/aj-foster.com/">Source</a>
      </div>
    </footer>
    <script defer data-domain="aj-foster.com" src="https://plausible.io/js/script.js"></script>
    <script async defer src="/assets/js/colors.js"></script>
  </body>
</html>
